<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Espa√ßo VIV</title>
    
    <!-- CSS Base -->
    <link rel="stylesheet" href="../css/style.css">
    
    <!-- Componentes -->
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            color: #333;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #2c5530, #6b8e23);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .dashboard-nav {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 20px;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }

        .nav-item {
            padding: 15px 0;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: #2c5530;
            border-bottom-color: #6b8e23;
        }

        .dashboard-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .welcome-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-info h1 {
            margin: 0 0 10px 0;
            color: #2c5530;
            font-size: 32px;
        }

        .welcome-info p {
            margin: 0;
            color: #666;
            font-size: 18px;
        }

        .welcome-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6b8e23, #8fbc8f);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 142, 35, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6b8e23;
            border: 2px solid #6b8e23;
        }

        .btn-secondary:hover {
            background: #6b8e23;
            color: white;
        }

        .content-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c5530;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .api-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #6b8e23;
        }

        .status-card.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .status-card h4 {
            margin: 0 0 10px 0;
            color: #2c5530;
        }

        .status-card p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-content {
                flex-wrap: wrap;
                justify-content: center;
            }

            .welcome-card {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .dashboard-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Cabe√ßalho -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo">
                üåø Espa√ßo VIV
            </div>
            <div class="user-menu">
                <span id="userWelcome">Bem-vindo!</span>
                <div class="user-avatar">üë§</div>
                <button class="btn btn-secondary" onclick="openAuthModal('login')" id="loginButton">
                    Entrar
                </button>
                <button class="btn btn-secondary" onclick="logout()" id="logoutButton" style="display: none;">
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Navega√ß√£o -->
    <nav class="dashboard-nav">
        <div class="nav-content">
            <div class="nav-item active" onclick="showSection('overview')">üìä Vis√£o Geral</div>
            <div class="nav-item" onclick="showSection('calendar')">üìÖ Calend√°rio</div>
            <div class="nav-item" onclick="showSection('auth')">üîê Autentica√ß√£o</div>
            <div class="nav-item" onclick="showSection('tests')">üß™ Testes de API</div>
        </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="dashboard-content">
        
        <!-- Se√ß√£o: Vis√£o Geral -->
        <section id="overview" class="content-section">
            <div class="welcome-card">
                <div class="welcome-info">
                    <h1>üåø Dashboard do Espa√ßo VIV</h1>
                    <p>Sistema integrado com todas as novas funcionalidades implementadas</p>
                </div>
                <div class="welcome-actions">
                    <button class="btn btn-primary" onclick="openAuthModal('register')">
                        üë§ Cadastrar-se
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('calendar')">
                        üìÖ Ver Calend√°rio
                    </button>
                </div>
            </div>

            <!-- Status das APIs -->
            <div class="test-panel">
                <h3 class="section-title">üåê Status das APIs</h3>
                <div id="apiStatus" class="api-status">
                    <!-- Status ser√° carregado dinamicamente -->
                </div>
            </div>
        </section>

        <!-- Se√ß√£o: Calend√°rio -->
        <section id="calendar" class="content-section" style="display: none;">
            <h2 class="section-title">üìÖ Calend√°rio Inteligente</h2>
            
            <!-- Incluir componente do calend√°rio -->
            <div id="calendarContainer">
                <!-- O calend√°rio ser√° carregado aqui -->
            </div>
        </section>

        <!-- Se√ß√£o: Autentica√ß√£o -->
        <section id="auth" class="content-section" style="display: none;">
            <h2 class="section-title">üîê Sistema de Autentica√ß√£o</h2>
            
            <div class="test-panel">
                <h4>Funcionalidades de Autentica√ß√£o</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="openAuthModal('login')">
                        üîë Fazer Login
                    </button>
                    <button class="btn btn-primary" onclick="openAuthModal('register')">
                        üë§ Cadastrar-se
                    </button>
                    <button class="btn btn-primary" onclick="openAuthModal('forgot')">
                        üîí Esqueci a Senha
                    </button>
                    <button class="btn btn-secondary" onclick="testPasswordValidation()">
                        üîç Testar Valida√ß√£o de Senha
                    </button>
                </div>

                <div id="authTestResults" style="margin-top: 20px;">
                    <!-- Resultados dos testes aparecer√£o aqui -->
                </div>
            </div>
        </section>

        <!-- Se√ß√£o: Testes de API -->
        <section id="tests" class="content-section" style="display: none;">
            <h2 class="section-title">üß™ Testes de API</h2>
            
            <div class="test-panel">
                <h4>Endpoints de Autentica√ß√£o</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="testAPI('health')">Health Check</button>
                    <button class="btn btn-secondary" onclick="testAPI('units')">Listar Unidades</button>
                    <button class="btn btn-secondary" onclick="testAPI('services')">Listar Servi√ßos</button>
                    <button class="btn btn-secondary" onclick="testAPI('validate-password')">Validar Senha</button>
                    <button class="btn btn-secondary" onclick="testAPI('calendar-day')">Calend√°rio Dia</button>
                    <button class="btn btn-secondary" onclick="testAPI('next-slot')">Pr√≥ximo Slot</button>
                </div>

                <div id="testResults" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
                    <!-- Resultados dos testes aparecer√£o aqui -->
                </div>
            </div>
        </section>

    </main>

    <!-- Incluir Modal de Autentica√ß√£o -->
    <div id="authModalContainer"></div>

    <!-- Scripts -->
    <script src="../js/api-service.js"></script>
    <script src="../js/auth-controller.js"></script>
    <script src="../js/smart-calendar-controller.js"></script>

    <script>
        // Controle de se√ß√µes
        function showSection(sectionId) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar se√ß√£o selecionada
            document.getElementById(sectionId).style.display = 'block';
            
            // Atualizar navega√ß√£o
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // Carregar conte√∫do espec√≠fico da se√ß√£o
            if (sectionId === 'calendar') {
                loadCalendar();
            }
        }

        // Carregar modal de autentica√ß√£o
        async function loadAuthModal() {
            try {
                const response = await fetch('../components/auth-modal.html');
                const html = await response.text();
                document.getElementById('authModalContainer').innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar modal de autentica√ß√£o:', error);
            }
        }

        // Carregar calend√°rio
        async function loadCalendar() {
            const container = document.getElementById('calendarContainer');
            if (container.innerHTML.trim() === '') {
                try {
                    const response = await fetch('../components/smart-calendar.html');
                    const html = await response.text();
                    container.innerHTML = html;
                    
                    // Reinicializar controlador do calend√°rio
                    setTimeout(() => {
                        if (window.SmartCalendarController) {
                            window.smartCalendar = new SmartCalendarController();
                        }
                    }, 100);
                } catch (error) {
                    console.error('Erro ao carregar calend√°rio:', error);
                }
            }
        }

        // Verificar status das APIs
        async function checkAPIStatus() {
            const statusContainer = document.getElementById('apiStatus');
            const apis = [
                { name: 'Health Check', endpoint: '/', icon: 'üíö' },
                { name: 'Unidades', endpoint: '/units', icon: 'üè¢' },
                { name: 'Servi√ßos', endpoint: '/services', icon: 'üíÜ' },
                { name: 'Valida√ß√£o de Senha', endpoint: '/auth/validate-password', method: 'POST', icon: 'üîí' }
            ];

            for (const api of apis) {
                const card = document.createElement('div');
                card.className = 'status-card';
                
                try {
                    let result;
                    if (api.method === 'POST') {
                        result = await window.apiService.request(api.endpoint, {
                            method: 'POST',
                            body: JSON.stringify({ password: 'test123' })
                        });
                    } else {
                        result = await window.apiService.request(api.endpoint);
                    }
                    
                    card.innerHTML = `
                        <h4>${api.icon} ${api.name}</h4>
                        <p>‚úÖ Online - Funcionando corretamente</p>
                    `;
                } catch (error) {
                    card.className = 'status-card error';
                    card.innerHTML = `
                        <h4>${api.icon} ${api.name}</h4>
                        <p>‚ùå Erro: ${error.message}</p>
                    `;
                }
                
                statusContainer.appendChild(card);
            }
        }

        // Testes de API espec√≠ficos
        async function testAPI(testType) {
            const resultsContainer = document.getElementById('testResults');
            
            const addResult = (title, content, success = true) => {
                const resultEl = document.createElement('div');
                resultEl.className = `status-card ${success ? '' : 'error'}`;
                resultEl.innerHTML = `
                    <h4>${success ? '‚úÖ' : '‚ùå'} ${title}</h4>
                    <pre style="white-space: pre-wrap; font-size: 12px; margin: 10px 0 0 0;">${content}</pre>
                `;
                resultsContainer.insertBefore(resultEl, resultsContainer.firstChild);
            };

            try {
                switch (testType) {
                    case 'health':
                        const health = await window.apiService.healthCheck();
                        addResult('Health Check', JSON.stringify(health, null, 2));
                        break;
                    
                    case 'units':
                        const units = await window.apiService.getUnits();
                        addResult('Listar Unidades', JSON.stringify(units, null, 2));
                        break;
                    
                    case 'services':
                        const services = await window.apiService.getServices();
                        addResult('Listar Servi√ßos', JSON.stringify(services, null, 2));
                        break;
                    
                    case 'validate-password':
                        const validation = await window.apiService.validatePassword('MinhaSenh@123');
                        addResult('Validar Senha', JSON.stringify(validation, null, 2));
                        break;
                    
                    case 'calendar-day':
                        const today = new Date().toISOString().split('T')[0];
                        const dayData = await window.apiService.getDayAvailability('sp-perdizes', today);
                        addResult('Calend√°rio do Dia', JSON.stringify(dayData, null, 2));
                        break;
                    
                    case 'next-slot':
                        const nextSlot = await window.apiService.getNextAvailableSlot('sp-perdizes');
                        addResult('Pr√≥ximo Slot Dispon√≠vel', JSON.stringify(nextSlot, null, 2));
                        break;
                }
            } catch (error) {
                addResult(`Erro em ${testType}`, error.message, false);
            }
        }

        // Testar valida√ß√£o de senha
        async function testPasswordValidation() {
            const passwords = ['123', 'senha123', 'MinhaSenh@123', 'UmaSenhaForteSemNumero!', 'teste'];
            const resultsContainer = document.getElementById('authTestResults');
            
            resultsContainer.innerHTML = '<h5>üîç Testando diferentes senhas:</h5>';
            
            for (const password of passwords) {
                try {
                    const result = await window.apiService.validatePassword(password);
                    const resultEl = document.createElement('div');
                    resultEl.className = 'status-card';
                    resultEl.innerHTML = `
                        <h4>Senha: "${password}"</h4>
                        <p><strong>For√ßa:</strong> ${result.strength} (${result.score}/5)</p>
                        <p><strong>V√°lida:</strong> ${result.is_valid ? 'Sim' : 'N√£o'}</p>
                        ${result.errors.length > 0 ? `<p><strong>Erros:</strong> ${result.errors.join(', ')}</p>` : ''}
                    `;
                    resultsContainer.appendChild(resultEl);
                } catch (error) {
                    console.error('Erro ao testar senha:', password, error);
                }
            }
        }

        // Logout
        function logout() {
            window.apiService.logout();
            updateUserInterface();
        }

        // Atualizar interface baseada no login
        function updateUserInterface() {
            const isLoggedIn = !!window.apiService.token;
            const loginBtn = document.getElementById('loginButton');
            const logoutBtn = document.getElementById('logoutButton');
            const userWelcome = document.getElementById('userWelcome');
            
            if (isLoggedIn) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userWelcome.textContent = 'Bem-vindo de volta!';
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userWelcome.textContent = 'Fa√ßa login para continuar';
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAuthModal();
            await checkAPIStatus();
            updateUserInterface();
            
            console.log('üöÄ Dashboard carregado com sucesso!');
            console.log('üì° API Base URL:', window.apiService?.baseURL);
        });
    </script>
</body>
</html>